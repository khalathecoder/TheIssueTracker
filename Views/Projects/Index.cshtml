@model IEnumerable<TheIssueTracker.Models.Project>

@using TheIssueTracker.Models.ViewModels;
@using TheIssueTracker.Models.Enums;
@using TheIssueTracker.Services.Interfaces;
@using TheIssueTracker.Services;

@inject IBTFileService _FileService;
@inject IBTProjectService _ProjectService;
@inject IBTRolesService _RolesService;


@{
	ViewData["Title"] = "All Projects";
}

<div class="container-fluid">
	<div class="row">
		<h2 class="m-t-0 h3"><b>All Projects </b></h2>
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="row justify-content-between">
						<div class="col-md-4">
							<div class="mt-3 mt-md-0">
								<a data-bs-toggle="modal" data-bs-target="#ProjectsCreate" class="btn btn-success width-lg w-md waves-effect waves-light"><i class="mdi mdi-plus"></i> Create Project</a>
							</div>
						</div><!-- end col-->
					</div> <!-- end row -->
				</div>
			</div> <!-- end card -->
		</div><!-- end col-->
	</div>

	<div class="row">
		@foreach (Project project in Model)
		{
			<div class="col-xl-4">
				<div class="card" style="max-width: 30rem">
					<div class="card-header">
						<div class="row">
							<div class="col">
								<h5 style="color:darkred">
									@if ((await _ProjectService.GetProjectManagerAsync(project.Id, project.CompanyId)) == null)
									{
										<div class="row row-cols-2">
											<div class="col d-flex align-items-center" style="color:darkred">Unassigned</div>
											<div class="col text-end"><a asp-action="IndexCopy" asp-controller="Projects" asp-route-id="@project.Id" data-bs-toggle="modal" data-bs-target="#AssignPM" class="btn btn-soft-warning .width-lg rounded-pill"><i class="mdi mdi-plus"></i> Manager</a></div>
										</div>
									}
									else
									{
										@await _ProjectService.GetProjectManagerAsync(project.Id, project.CompanyId)
										;
										<h6 class="text-muted">Project Manager</h6>
									}
								</h5>
							</div>
						</div>

					</div>
					<div class="card-body">
						<div class="text-center">
							<span class="text-muted">Priority Level: </span> @if (project.ProjectPriority!.Name == "Urgent")
							{
								<h5 style="color:firebrick">Urgent</h5>
							}
							else if (project.ProjectPriority!.Name == "High")
							{
								<h5 style="color:orangered">High</h5>

							}
							else if (project.ProjectPriority!.Name == "Medium")
							{
								<h5 style="color:darkslateblue">Medium</h5>
							}
							else if (project.ProjectPriority!.Name == "Low")
							{
								<h5 style="color:forestgreen">Low</h5>
							}
						</div>
						<div><a asp-controller="Projects" asp-action="Details" asp-route-id="@project.Id"><h5 class="card-title text-center">@project.Name</h5></a></div>
						<div class="text-truncate">
							<a asp-controller="Projects" asp-action="Details" asp-route-id="@project.Id"><p class="text-center">@Html.Raw(project.Description)</p></a>
						</div>
					</div>
					<div class="card-footer">
						<div class="row row-cols-2">
							<div class="col">
								Developers:
							</div>
							<div class="col">
								Submitters:
							</div>
						</div>
					</div>
				</div>
			</div>
		}
	</div>
</div>


@*MODALS*@
@*ASSIGN PM Modal*@
<div class="modal fade" id="AssignPM" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="AssignPMLabel">Assign Project Manager to Project</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				@{
					AssignPMViewModel assignPMViewModel = new();
				}
				@*
				<form asp-action="AssignPM" method="post" class="d-flex flex-column">
					<input type="hidden" asp-for="@assignPMViewModel.Project!.Id" />
					<select asp-items="@assignPMViewModel.PMList" asp-for="@assignPMViewModel.PMId">
						<option value="">Unassigned</option>
					</select>
					<button type="submit" class="btn btn-primary my-3">Save</button>

					<a asp-action="Details" asp-route-id="@assignPMViewModel.Project!.Id" class="btn btn-secondary">Cancel</a>
				</form>*@
			</div>
		</div>
	</div>
</div>

@*CREATE PROJECT Modal*@
<div class="modal fade" id="ProjectsCreate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="ProjectsCreateLabel">Create New Project</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				@{
					Project newProject = new();
				}
				<form asp-action="Create" asp-controller="Projects" method="post" enctype="multipart/form-data">
					<div asp-validation-summary="ModelOnly" class="text-danger"></div>
					<div class="row">
						<div class="col-12 col-lg-4">
							<div class="form-group">
								<label asp-for="@newProject.ImageFormFile" class="control-label">Project Image</label>
								<img class="img-fluid border rounded-3 mb-2" style="max-height: 350px;" src="@_FileService.ConvertByteArrayToFile(newProject.ImageFileData,newProject.ImageFileType,DefaultImage.ProjectImage)">
								<input asp-for="@newProject.ImageFormFile" type="file" class="form-control mt-3 pt-2" accept=".png,.jpg,.jpeg,.gif"
									   onchange="document.getElementById('blogImage').src = window.URL.createObjectURL(this.files[0])" />
							</div>
							<div class="form-group">
								<label asp-for="@newProject.Name" class="control-label"></label>
								<input asp-for="@newProject.Name" class="form-control" />
								<span asp-validation-for="@newProject.Name" class="text-danger"></span>
							</div>
							<div class="form-group">
								<label asp-for="@newProject.StartDate" class="control-label"></label>
								<input asp-for="@newProject.StartDate" class="form-control" />
								<span asp-validation-for="@newProject.StartDate" class="text-danger"></span>
							</div>
							<div class="form-group">
								<label asp-for="@newProject.EndDate" class="control-label"></label>
								<input asp-for="@newProject.EndDate" class="form-control" />
								<span asp-validation-for="@newProject.EndDate" class="text-danger"></span>
							</div>
						</div>
						<div class="col-12 col-lg-8">
							<div class="form-group">
								<label asp-for="@newProject.Description" class="control-label"></label>
								<textarea asp-for="@newProject.Description" class="editor form-control"></textarea>
								<span asp-validation-for="@newProject.Description" class="text-danger"></span>
							</div>
							<div class="form-group" id="tagContainer">
								<label asp-for="@newProject.ProjectPriorityId" class="control-label">Project Priority</label>
								<select asp-for="@newProject.ProjectPriorityId" class="form-control" asp-items="ViewBag.ProjectPriorityId"></select>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<input type="submit" value="Create" class="btn btn-success" />
						<input type="submit" value="Close" asp-action="Index" data-bs-dismiss="modal" class="btn btn-secondary" />
					</div>
				</form>
			</div>

		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<!--CK Editor-->
	<script src="https://cdn.ckeditor.com/ckeditor5/37.1.0/classic/ckeditor.js"></script>

	<script>
		ClassicEditor
			.create(document.querySelector('.editor'), {
				licenseKey: '',
			})
			.then(editor => {
				window.editor = editor;
			});
	</script>
}